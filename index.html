<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é•¿åº¦é­”æ³•å¸ˆï¼šé•¿åº¦å•ä½åŠ å‡æ¸¸æˆ</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å¼•å…¥ä¸­æ–‡å­—ä½“ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+SC:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans SC', 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #e0e7ff 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
        }
        .btn-primary {
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .game-card {
            background-color: white;
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* ç¡®ä¿è¾“å…¥æ¡†ä¸ç«–å¼å¯¹é½ */
        .answer-input-container {
            width: 256px; /* å›ºå®šçš„å®½åº¦ï¼Œä¸é—®é¢˜åŒºåŸŸä¸€è‡´ w-64 */
        }
    </style>
</head>
<body class="p-4">

    <!-- ä¸»åº”ç”¨å®¹å™¨ -->
    <div id="app" class="container mx-auto p-4 md:p-8 rounded-xl">
        
        <!-- å¤´éƒ¨å¯¼èˆªæ  -->
        <header class="bg-indigo-600 text-white p-4 rounded-xl shadow-lg flex flex-col md:flex-row justify-between items-center mb-6 sticky top-0 z-10">
            <h1 class="text-3xl font-bold mb-3 md:mb-0">ğŸ“ é•¿åº¦é­”æ³•å¸ˆ</h1>
            <nav id="navbar" class="flex flex-wrap justify-center gap-2 md:gap-4">
                <button class="nav-btn bg-indigo-700 hover:bg-indigo-800" onclick="changeView('home')">ä¸»é¡µ</button>
                <button class="nav-btn bg-indigo-700 hover:bg-indigo-800" onclick="changeView('manual')">é­”æ³•æ‰‹å†Œ</button>
                <button class="nav-btn bg-indigo-700 hover:bg-indigo-800" onclick="changeView('city')">åŸå¸‚æ¢é™© (km/m)</button>
                <button class="nav-btn bg-indigo-700 hover:bg-indigo-800" onclick="changeView('micro')">å¾®è§‚ä¸–ç•Œ (cm/mm)</button>
            </nav>
        </header>

        <!-- å†…å®¹åŒºåŸŸ -->
        <main id="content-area" class="mt-8">
            <!-- å„ä¸ªè§†å›¾å°†åŠ¨æ€æ’å…¥åˆ°è¿™é‡Œ -->
        </main>
        
        <!-- ç»“æœåé¦ˆåŒºåŸŸ -->
        <div id="feedback" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div id="feedback-card" class="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-sm transform scale-90 transition-all duration-300">
                <h2 id="feedback-message" class="text-3xl font-bold mb-4"></h2>
                <p id="feedback-details" class="text-gray-600 mb-6"></p>
                <button class="btn-primary bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3" onclick="hideFeedback()">ç»§ç»­æŒ‘æˆ˜</button>
            </div>
        </div>

    </div>

    <script>
        // å…¨å±€çŠ¶æ€ç®¡ç†
        const state = {
            currentView: 'home',
            currentProblem: null,
            score: 0,
            roundCount: 0, // å½“å‰å·²å®Œæˆ/å·²å°è¯•çš„å›åˆæ•° (1åˆ°maxRounds)
            maxRounds: 10 // æœ€å¤§å›åˆæ•°
        };

        // DOM å…ƒç´ å¼•ç”¨
        const contentArea = document.getElementById('content-area');
        const feedbackEl = document.getElementById('feedback');
        const feedbackMessageEl = document.getElementById('feedback-message');
        const feedbackDetailsEl = document.getElementById('feedback-details');

        // åˆå§‹åŒ–å‡½æ•°
        window.onload = function() {
            // é»˜è®¤åŠ è½½åˆ°å¾®è§‚ä¸–ç•Œæ¨¡å¼ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªæ–°çš„éšæœºé—®é¢˜
            changeView('home');
        };

        /**
         * è®¾ç½®ä¸€ä¸ªç‰¹å®šçš„é—®é¢˜ï¼Œå¹¶å¼€å§‹æ¸¸æˆ (ä¿ç•™æ­¤å‡½æ•°ä»¥å¤‡ç”¨æˆ·åç»­æ‰‹åŠ¨è®¾ç½®é¢˜ç›®)
         */
        function setSpecificProblem(type, operation, A, B, C, D) {
             const factor = type === 'city' ? 1000 : 10;
             const unit1 = type === 'city' ? 'km' : 'cm';
             const unit2 = type === 'city' ? 'm' : 'mm';

             // è®¡ç®—æ­£ç¡®ç­”æ¡ˆ
             const total1 = A * factor + B;
             const total2 = C * factor + D;
             let totalResult = operation === '+' ? (total1 + total2) : (total1 - total2);
            
             if (totalResult < 0) {
                 console.error("é”™è¯¯ï¼šå‡æ³•ç»“æœä¸ºè´Ÿæ•°ï¼Œæ— æ³•è®¾ç½®é¢˜ç›®ã€‚");
                 changeView('home');
                 return;
             }

             const resultU1 = Math.floor(totalResult / factor);
             const resultU2 = totalResult % factor;

             state.currentProblem = {
                 type, unit1, unit2, A, B, C, D, operation, resultU1, resultU2, factor
             };
             
             changeView(type);
        }

        // =========================================================
        // æ ¸å¿ƒæ•°å­¦å’Œé€»è¾‘å‡½æ•°
        // =========================================================

        /**
         * ç”Ÿæˆéšæœºé•¿åº¦å•ä½é—®é¢˜
         * @param {string} type - 'city' (km/m) æˆ– 'micro' (cm/mm)
         * @param {string} operation - '+' æˆ– '-'
         * @returns {object} åŒ…å«æ“ä½œæ•°ã€è¿ç®—ç¬¦å’Œæ­£ç¡®ç­”æ¡ˆçš„å¯¹è±¡
         */
        function generateProblem(type, operation) {
            const factor = type === 'city' ? 1000 : 10;
            const unit1 = type === 'city' ? 'km' : 'cm';
            const unit2 = type === 'city' ? 'm' : 'mm';

            let A, B, C, D;
            let resultU1, resultU2;
            
            // 70% çš„æ¦‚ç‡ç”Ÿæˆéœ€è¦è¿›ä½/å€Ÿä½çš„æŒ‘æˆ˜æ€§é¢˜ç›®
            const isChallenging = Math.random() < 0.7; 

            const maxU1_city = 12; 
            const maxU1_micro = 8; 

            if (operation === '-') {
                const maxA = type === 'city' ? maxU1_city : maxU1_micro;
                
                A = Math.floor(Math.random() * (maxA - 4 + 1)) + 4; 
                C = Math.floor(Math.random() * (A - 1)) + 1;     
                
                if (isChallenging) {
                    D = Math.floor(Math.random() * (factor - 5)) + 5; 
                    B = Math.floor(Math.random() * Math.min(D - 1, factor / 3)) + 1; 

                    while (A * factor + B <= C * factor + D) {
                        A++; 
                    }
                } else {
                    B = Math.floor(Math.random() * factor);
                    D = Math.floor(Math.random() * B);

                    if (A === C && B === D) {
                         D = Math.floor(Math.random() * B);
                         if (D === B) { D = Math.max(0, B - 1); }
                    }
                }

            } else { // åŠ æ³• '+'
                const maxAC = type === 'city' ? 7 : 4; 

                A = Math.floor(Math.random() * maxAC) + 1; 
                C = Math.floor(Math.random() * maxAC) + 1; 
                
                if (isChallenging) {
                    B = Math.floor(Math.random() * (factor / 2)) + Math.ceil(factor / 2) - 1; 
                    D = Math.floor(Math.random() * (factor / 2)) + 1;

                    B = Math.min(B, factor - 1);
                    D = Math.min(D, factor - 1);

                } else {
                    B = Math.floor(Math.random() * (factor / 2));
                    D = Math.floor(Math.random() * (factor / 2));
                }
            }
            
            const total1 = A * factor + B;
            const total2 = C * factor + D;
            let totalResult = operation === '+' ? (total1 + total2) : (total1 - total2);

            resultU1 = Math.floor(totalResult / factor);
            resultU2 = totalResult % factor;

            state.currentProblem = {
                type, unit1, unit2, A, B, C, D, operation, resultU1, resultU2, factor
            };
            return state.currentProblem;
        }

        /**
         * æ£€æŸ¥ç”¨æˆ·çš„ç­”æ¡ˆæ˜¯å¦æ­£ç¡®
         */
        function checkAnswer(type) {
            const problem = state.currentProblem;
            if (!problem || problem.type !== type) return;

            const inputU1 = document.getElementById('inputU1').value;
            const inputU2 = document.getElementById('inputU2').value;

            const userU1 = parseInt(inputU1);
            const userU2 = parseInt(inputU2);

            if (isNaN(userU1) || isNaN(userU2)) {
                showMessage('å“å‘€ï¼', 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—å“¦ï¼Œå°é­”æ³•å¸ˆï¼', 'bg-red-500');
                return;
            }

            if (userU2 >= problem.factor) {
                 showMessage('æ ¼å¼é”™è¯¯', `å°å•ä½ (${problem.unit2}) ä¸èƒ½å¤§äºæˆ–ç­‰äº ${problem.factor}ã€‚è¯·è®°å¾—è¿›ä½ï¼`, 'bg-red-500');
                 return;
            }
            
            const userTotal = userU1 * problem.factor + userU2;
            const correctTotal = problem.resultU1 * problem.factor + problem.resultU2;


            if (userTotal === correctTotal && userU2 === problem.resultU2) {
                state.score++;
                showMessage('ğŸ‰ å¤ªæ£’äº†ï¼', `ä½ ç®—å¯¹å•¦ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯ ${problem.resultU1}${problem.unit1}${problem.resultU2}${problem.unit2}ã€‚`, 'bg-green-500', true, type);
            } else if (userTotal === correctTotal && userU2 !== problem.resultU2) {
                let hint = `æ€»é•¿åº¦æ˜¯æ­£ç¡®çš„ï¼Œä½†ä½ å¿˜è®°äº†**è¿›ä½**æˆ–**å€Ÿä½**ï¼`;
                hint += `<br>è¯·æ³¨æ„ï¼š${problem.factor}${problem.unit2} ç­‰äº 1${problem.unit1}ã€‚æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š${problem.resultU1}${problem.unit1}${problem.resultU2}${problem.unit2}ã€‚`;
                 showMessage('ğŸ¤” å·®ç‚¹æˆåŠŸï¼', hint, 'bg-orange-500', false, type);
            }
             else {
                let hint = `æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š${problem.resultU1}${problem.unit1}${problem.resultU2}${problem.unit2}ã€‚`;
                hint += `<br>è¯·æ³¨æ„ï¼š${problem.factor}${problem.unit2} ç­‰äº 1${problem.unit1}ã€‚ä½ éœ€è¦è¿›è¡Œ**è¿›ä½**æˆ–**å€Ÿä½**è¿ç®—å“¦ï¼`;
                showMessage('ğŸ˜Ÿ å†è¯•è¯•ï¼', hint, 'bg-red-500', false, type);
            }
        }
        
        /**
         * åŠ¨ç”»æ•ˆæœ/åé¦ˆå±•ç¤º
         */
        function showMessage(title, detail, colorClass, isCorrect, nextGame) {
            feedbackMessageEl.textContent = title;
            feedbackDetailsEl.innerHTML = detail;
            const card = document.getElementById('feedback-card');
            // è®¾ç½®å¡ç‰‡çš„é¢œè‰²å’Œæ ·å¼
            card.className = `game-card text-center max-w-sm transform scale-100 transition-all duration-300 ${colorClass} text-white`;

            const button = feedbackEl.querySelector('button');
            const isGameOver = state.roundCount >= state.maxRounds;

            if (isCorrect) {
                // å¦‚æœç­”å¯¹
                if (isGameOver) {
                    // æ¸¸æˆç»“æŸ
                    button.textContent = 'æŸ¥çœ‹æ€»æˆç»©';
                    button.onclick = () => { hideFeedback(); renderFinalScore(); };
                    feedbackMessageEl.textContent = 'æŒ‘æˆ˜æˆåŠŸï¼';
                    feedbackDetailsEl.innerHTML = `ä½ å·²å®Œæˆæ‰€æœ‰ ${state.maxRounds} é¢˜æŒ‘æˆ˜ï¼Œå¾—åˆ†å·²æ›´æ–°ã€‚`;
                } else {
                    // ç»§ç»­ä¸‹ä¸€é¢˜
                    button.textContent = 'ä¸‹ä¸€é¢˜ï¼';
                    button.onclick = () => { hideFeedback(); renderGame(nextGame, true); };
                }
            } else {
                // å¦‚æœç­”é”™ï¼Œå…è®¸é‡è¯•ï¼Œä¸è¿›å…¥ä¸‹ä¸€å›åˆ
                button.textContent = 'å†è¯•ä¸€æ¬¡';
                button.onclick = () => { hideFeedback(); };
            }

            feedbackEl.classList.remove('hidden');
            feedbackEl.classList.add('flex');
        }

        function hideFeedback() {
            feedbackEl.classList.remove('flex');
            feedbackEl.classList.add('hidden');
            
            if (state.currentProblem) {
                 const currentType = state.currentProblem.type;
                 const inputU1 = document.getElementById('inputU1');
                 const inputU2 = document.getElementById('inputU2');
                 if (inputU1 && inputU2) {
                     // ä¿å­˜ç”¨æˆ·çš„è¾“å…¥ï¼Œä»¥ä¾¿åœ¨é‡è¯•æ—¶æ¢å¤
                     state.currentProblem.userU1 = inputU1.value;
                     state.currentProblem.userU2 = inputU2.value;
                 }
                 renderGame(currentType, false); // é‡æ–°æ¸²æŸ“å½“å‰é—®é¢˜
            }
        }

        /**
         * é‡ç½®æ¸¸æˆçŠ¶æ€å¹¶å¼€å§‹æ–°æ¸¸æˆ
         */
        function resetGameAndStart(type) {
            state.score = 0;
            state.roundCount = 0;
            state.currentProblem = null;
            changeView(type);
        }

        /**
         * æ¸²æŸ“æœ€ç»ˆå¾—åˆ†ç•Œé¢
         */
        function renderFinalScore() {
            state.currentProblem = null; // æ¸…é™¤å½“å‰é—®é¢˜çŠ¶æ€

            contentArea.innerHTML = `
                <div class="game-card text-center">
                    <h2 class="text-xl sm:text-3xl font-extrabold text-indigo-600 mb-4">ğŸ† æŒ‘æˆ˜å®Œæˆï¼</h2>
                    <p class="text-xl text-gray-700 mb-2">å°é­”æ³•å¸ˆï¼Œä½ æˆåŠŸå®Œæˆäº† ${state.maxRounds} å›åˆçš„é•¿åº¦æŒ‘æˆ˜ï¼</p>
                    
                    <div class="bg-indigo-50 p-6 rounded-xl inline-block mb-8 shadow-lg">
                        <p class="text-2xl font-semibold text-indigo-700">ä½ çš„æ€»å¾—åˆ†æ˜¯ï¼š</p>
                        <p class="text-6xl font-extrabold text-indigo-900 mt-0">${state.score} / ${state.maxRounds}</p>
                    </div>

                    <div class="flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-6">
                        <button class="btn-primary bg-indigo-700 hover:bg-indigo-800 text-white text-xl py-4 px-8" onclick="resetGameAndStart('city')">
                            å†ç©ä¸€æ¬¡ (åŸå¸‚)
                        </button>
                        <button class="btn-primary bg-indigo-700 hover:bg-indigo-800 text-white text-xl py-4 px-8" onclick="resetGameAndStart('micro')">
                            å†ç©ä¸€æ¬¡ (å¾®è§‚)
                        </button>
                    </div>
                </div>
            `;
            // æ³¨æ„: scoreå’ŒroundCountåœ¨resetGameAndStartä¸­é‡ç½®
        }


        // =========================================================
        // è§†å›¾æ¸²æŸ“å‡½æ•°
        // =========================================================

        /**
         * æ”¹å˜ä¸»è§†å›¾
         */
        function changeView(viewName) {
            state.currentView = viewName;
            contentArea.innerHTML = '';
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-opacity-50', 'ring-2', 'ring-white');
            });
            const currentButton = document.querySelector(`.nav-btn[onclick*="${viewName}"]`);
            if (currentButton) {
                currentButton.classList.add('bg-opacity-50', 'ring-2', 'ring-white');
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯ä»ä¸»é¡µåˆ‡æ¢åˆ°æ¸¸æˆæ¨¡å¼
            const isGameView = viewName === 'city' || viewName === 'micro';
            const shouldGenerateNew = isGameView && (state.currentProblem === null || state.currentProblem.type !== viewName);
            
            switch (viewName) {
                case 'home':
                    state.currentProblem = null;
                    state.score = 0; // åˆ‡æ¢åˆ°ä¸»é¡µæ—¶é‡ç½®åˆ†æ•°
                    state.roundCount = 0; // åˆ‡æ¢åˆ°ä¸»é¡µæ—¶é‡ç½®å›åˆæ•°
                    renderHome();
                    break;
                case 'manual':
                    renderManual();
                    break;
                case 'city':
                    renderGame('city', shouldGenerateNew);
                    break;
                case 'micro':
                    renderGame('micro', shouldGenerateNew);
                    break;
            }
        }

        function renderHome() {
            contentArea.innerHTML = `
                <div class="game-card text-center">
                    <h2 class="text-xl sm:text-3xl font-extrabold text-indigo-600 mb-4">æ¬¢è¿æ¥åˆ°é•¿åº¦é­”æ³•å¸ˆçš„ä¸–ç•Œï¼</h2>
                    <p class="text-lg text-gray-700 mb-8">å°ä¾¦æ¢ï¼Œå‡†å¤‡å¥½ç”¨ä½ çš„æ•°å­¦é­”æ³•è§£å†³é•¿åº¦å•ä½çš„åŠ å‡æ³•äº†å—ï¼Ÿ</p>
                    
                    <div class="flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-6">
                        <button class="btn-primary bg-indigo-700 hover:bg-indigo-800 text-white text-xl py-4 px-8" onclick="changeView('city')">
                            ğŸ™ï¸ åŸå¸‚æ¢é™© (km/m)
                        </button>
                        <button class="btn-primary bg-indigo-700 hover:bg-indigo-800 text-white text-xl py-4 px-8" onclick="changeView('micro')">
                            ğŸ”¬ å¾®è§‚ä¸–ç•Œ (cm/mm)
                        </button>
                    </div>

                    <div class="mt-8 p-4 bg-indigo-50 rounded-lg border-l-4 border-indigo-400">
                        <p class="text-sm text-gray-600">åˆ«å¿˜äº†å…ˆå» <button class="text-indigo-600 font-semibold underline" onclick="changeView('manual')">é­”æ³•æ‰‹å†Œ</button> å­¦ä¹ æ¢ç®—è§„åˆ™å“¦ï¼</p>
                    </div>
                </div>
            `;
        }

        function renderManual() {
            contentArea.innerHTML = `
                <div class="game-card">
                    <h2 class="text-3xl font-bold text-indigo-600 mb-6 border-b pb-2">é­”æ³•æ‰‹å†Œ (å•ä½æ¢ç®—è§„åˆ™) ğŸ“š</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- å¤§å•ä½æ¢ç®— -->
                        <div class="p-4 bg-indigo-50 rounded-xl shadow-inner">
                            <h3 class="text-2xl font-semibold text-indigo-700 mb-3">åŸå¸‚æ¢é™© (å…¬é‡Œ/ç±³)</h3>
                            <p class="text-lg mb-2">å½“ç±³æ•°è¾¾åˆ° 1000 æ—¶ï¼Œå°±éœ€è¦**è¿›ä½**åˆ°å…¬é‡Œã€‚</p>
                            <p class="text-xl font-bold text-red-600">1 km = 1000 m</p>
                            <p class="text-sm text-gray-500 mt-3">åŠ æ³•è¿›ä½ï¼š500 m + 600 m = 1 km 100 m</p>
                            <p class="text-sm text-gray-500">å‡æ³•å€Ÿä½ï¼šä» 1 km å€Ÿå‡º 1000 m</p>
                            
                        </div>

                        <!-- å°å•ä½æ¢ç®— -->
                        <div class="p-4 bg-yellow-50 rounded-xl shadow-inner">
                            <h3 class="text-2xl font-semibold text-yellow-700 mb-3">å¾®è§‚ä¸–ç•Œ (å˜ç±³/æ¯«ç±³)</h3>
                            <p class="text-lg mb-2">å½“æ¯«ç±³æ•°è¾¾åˆ° 10 æ—¶ï¼Œå°±éœ€è¦**è¿›ä½**åˆ°å˜ç±³ã€‚</p>
                            <p class="text-xl font-bold text-red-600">1 cm = 10 mm</p>
                            <p class="text-sm text-gray-500 mt-3">åŠ æ³•è¿›ä½ï¼š9 mm + 7 mm = 1 cm 6 mm</p>
                            <p class="text-sm text-gray-500">å‡æ³•å€Ÿä½ï¼šä» 1 cm å€Ÿå‡º 10 mm</p>
                            
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * æ¸²æŸ“æ¸¸æˆç•Œé¢
         */
        function renderGame(type, newProblem = true) {
            const isCity = type === 'city';
            const title = isCity ? 'åŸå¸‚æ¢é™© (km/m) ğŸ™ï¸' : 'å¾®è§‚ä¸–ç•Œ (cm/mm) ğŸ”¬';
            const unit1 = isCity ? 'km' : 'cm';
            const unit2 = isCity ? 'm' : 'mm';
            const factor = isCity ? 1000 : 10;
            
            const operation = Math.random() < 0.5 ? '+' : '-';
            
            if (newProblem || state.currentProblem === null || state.currentProblem.type !== type) {
                
                // æ£€æŸ¥æ˜¯å¦å·²è¾¾åˆ°æœ€å¤§å›åˆæ•°
                if (state.roundCount >= state.maxRounds) {
                    renderFinalScore();
                    return;
                }
                
                generateProblem(type, operation);
                state.currentProblem.userU1 = ''; 
                state.currentProblem.userU2 = '';

                // åªæœ‰ç”Ÿæˆæ–°é—®é¢˜æ—¶æ‰å¢åŠ å›åˆè®¡æ•°
                state.roundCount++;
            } 
            
            const p = state.currentProblem;
            
            // ç¡®ä¿å½“å‰é—®é¢˜çš„ç±»å‹ä¸è§†å›¾åŒ¹é…
            if (p.type !== type) {
                 // é‡æ–°ç”Ÿæˆä¸€ä¸ªç¬¦åˆå½“å‰æ¨¡å¼çš„é—®é¢˜ï¼Œå¹¶é‡ç½®å›åˆè®¡æ•°
                 state.roundCount = 1;
                 generateProblem(type, operation);
                 state.currentProblem.userU1 = '';
                 state.currentProblem.userU2 = '';
            }

            contentArea.innerHTML = `
                <div class="game-card">
                    <h2 class="text-3xl font-bold text-center mb-6 ${isCity ? 'text-green-600' : 'text-yellow-600'}">${title}</h2>
                    <div class="flex justify-between items-center mb-4 text-base sm:text-lg font-semibold text-gray-700">
                        <span>å›åˆ: ${state.roundCount} / ${state.maxRounds}</span>
                        <span>å½“å‰å¾—åˆ†: ${state.score}</span>
                        <button class="text-sm text-indigo-500 hover:text-indigo-700 underline" onclick="renderGame('${type}', true)">æ¢ä¸€é¢˜</button>
                    </div>

                    <!-- é—®é¢˜å±•ç¤ºåŒº (ç«–å¼) -->
                    <div class="flex flex-col items-center p-6 bg-gray-50 rounded-xl  mb-8">
                        
                        <div class="flex flex-col items-end w-full max-w-80">
                            <!-- ç¬¬ä¸€è¡Œ: è¢«åŠ æ•°/è¢«å‡æ•° -->
                            <div class="text-xl sm:text-3xl font-extrabold text-gray-800 flex justify-end w-full">
                                <span class="text-right w-1/2 pr-1">${p.A} <span class="text-base sm:text-lg font-semibold">${unit1}</span></span>
                                <span class="text-right w-1/2 pr-1">${p.B} <span class="text-base sm:text-lg font-semibold">${unit2}</span></span>
                            </div>

                            <!-- ç¬¬äºŒè¡Œ: è¿ç®—ç¬¦å’ŒåŠ æ•°/å‡æ•° -->
                            <div class="text-xl sm:text-3xl font-extrabold text-gray-800 flex justify-end w-full mt-2 border-b-2 border-gray-400 pb-2">
                                <span class="w-1/12 text-left">${p.operation}</span>
                                <span class="text-right w-1/4 pr-2">${p.C} <span class="text-base sm:text-lg font-semibold">${unit1}</span></span>
                                <span class="text-right w-1/2">${p.D} <span class="text-base sm:text-lg font-semibold">${unit2}</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- ç­”æ¡ˆè¾“å…¥åŒºï¼ˆå¯¹é½ç«–å¼ï¼‰ -->
<div class="flex flex-col items-center mt-2">
    <div class="w-full max-w-80 flex justify-end">
        <div class="flex w-full justify-end  ">
            <div class="flex items-center w-1/2 pr-2 justify-end space-x-2">
    <input type="number" id="inputU1" class="w-20 text-center text-2xl p-2 border-4 rounded-lg ${isCity ? 'border-green-400' : 'border-yellow-400'}" value="${p.userU1 || ''}">
    <span class="text-base sm:text-lg font-semibold">${unit1}</span>
</div>
            <div class="flex items-center w-1/2 justify-end space-x-2">
    <input type="number" id="inputU2" class="w-20 text-center text-2xl p-2 border-4 rounded-lg ${isCity ? 'border-green-400' : 'border-yellow-400'}" value="${p.userU2 || ''}">
    <span class="text-base sm:text-lg font-semibold">${unit2}</span>
</div>
        </div>
    </div>

    <p class="text-sm text-red-500 mb-4 mt-2">* å°å•ä½ (${unit2}) çš„æ•°å­—å¿…é¡»å°äº ${factor}ã€‚</p>

    <button class="btn-primary w-full max-w-xs text-xl py-3 text-white font-bold rounded-xl ${isCity ? 'bg-green-600 hover:bg-green-700' : 'bg-yellow-600 hover:bg-yellow-700'}" onclick="checkAnswer('${type}')">
        æäº¤ç­”æ¡ˆ
    </button>
</div>
            `;

            if (!newProblem && p.userU1 !== undefined) {
                document.getElementById('inputU1').value = p.userU1;
                document.getElementById('inputU2').value = p.userU2;
            } else {
                 state.currentProblem.userU1 = '';
                 state.currentProblem.userU2 = '';
            }
        }
    </script>
</body>
</html>
